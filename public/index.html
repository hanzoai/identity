<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanzo Identity dApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #ff6b6b;
            --accent-hover: #ff5252;
            --border: #333;
            --success: #4caf50;
            --error: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Navigation */
        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
        }

        .nav-brand svg {
            width: 32px;
            height: 32px;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--text-primary);
        }

        .btn {
            padding: 10px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #3a3a3a;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Home Page */
        .home-hero {
            text-align: center;
            padding: 100px 20px;
        }

        .home-hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .home-hero p {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        /* Identities Page */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 36px;
        }

        .search-box {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-bottom: 24px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .identities-table {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: 1fr 200px;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 200px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: background 0.2s;
        }

        .table-row:hover {
            background: var(--bg-tertiary);
            cursor: pointer;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .identity-name {
            color: var(--accent);
            font-weight: 500;
        }

        .staked-amount {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kai-icon {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            display: inline-block;
        }

        /* Profile Page */
        .profile-header {
            font-size: 32px;
            margin-bottom: 24px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .info-value {
            font-family: monospace;
            color: var(--text-primary);
            word-break: break-all;
            max-width: 60%;
            text-align: right;
        }

        .separator {
            height: 1px;
            background: var(--border);
            margin: 24px 0;
        }

        /* Register Page */
        .register-card {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 40px;
        }

        .register-card h1 {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .register-card .subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .price-display {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .status.info {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .wallet-info {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
        }

        .wallet-info.show {
            display: block;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .balance {
            margin-top: 8px;
            color: var(--accent);
            font-weight: 600;
        }

        .load-more {
            text-align: center;
            margin-top: 24px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            nav {
                padding: 12px 16px;
            }

            .nav-links {
                gap: 12px;
                font-size: 14px;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .table-header,
            .table-row {
                grid-template-columns: 1fr auto;
            }

            .register-card {
                padding: 24px;
            }

            .home-hero h1 {
                font-size: 32px;
            }

            .info-value {
                max-width: 50%;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <a href="#/" class="nav-brand" data-testid="nav-brand">
            <svg viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M22.21 67V44.6369H0V67H22.21Z" fill="#ffffff" opacity="1"></path><path d="M0 44.6369L22.21 46.8285V44.6369H0Z" fill="#DDDDDD" opacity="1"></path><path d="M66.7038 22.3184H22.2534L0.0878906 44.6367H44.4634L66.7038 22.3184Z" fill="#ffffff" opacity="1"></path><path d="M22.21 0H0V22.3184H22.21V0Z" fill="#ffffff" opacity="1"></path><path d="M66.7198 0H44.5098V22.3184H66.7198V0Z" fill="#ffffff" opacity="1"></path><path d="M66.6753 22.3185L44.5098 20.0822V22.3185H66.6753Z" fill="#DDDDDD" opacity="1"></path><path d="M66.7198 67V44.6369H44.5098V67H66.7198Z" fill="#ffffff" opacity="1"></path></svg>
            <span>Hanzo</span>
        </a>
        <div class="nav-links">
            <a href="#/" data-route="home" data-testid="nav-home">Home</a>
            <a href="#/identities" data-route="identities" data-testid="nav-identities">Protocol Identities</a>
            <a href="#/register" data-route="register" data-testid="nav-register">Register</a>
            <a href="https://sepolia.basescan.org/address/0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9" target="_blank">Smart Contract</a>
            <button id="navConnectBtn" class="btn" onclick="connectWallet()" data-testid="nav-connect-button">
                Connect Wallet
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Home Page -->
        <div id="homePage" class="page active" data-testid="home-page">
            <div class="home-hero">
                <h1>Hanzo Identity</h1>
                <p>Connect your wallet to get started with using the Hanzo dApp</p>
                <button class="btn" onclick="connectWallet()" data-testid="home-connect-button">Connect Wallet</button>
            </div>
        </div>

        <!-- Identities Page -->
        <div id="identitiesPage" class="page" data-testid="identities-page">
            <div class="page-header">
                <h1>Protocol Identities</h1>
            </div>

            <div class="search-box">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Search identity name..."
                    data-testid="search-input"
                >
            </div>

            <div class="identities-table">
                <div class="table-header">
                    <div>Identity</div>
                    <div>Staked AI</div>
                </div>
                <div id="identitiesList" data-testid="identities-list">
                    <!-- Identities will be loaded here -->
                </div>
            </div>

            <div class="load-more">
                <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMoreIdentities()" data-testid="load-more-button">
                    Load More
                </button>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page" data-testid="profile-page">
            <h1 class="profile-header" id="profileName"></h1>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('info')" data-testid="tab-info">Info</button>
                <button class="tab" onclick="switchTab('rewards')" data-testid="tab-rewards">Rewards</button>
                <button class="tab" onclick="switchTab('delegations')" data-testid="tab-delegations">Delegations</button>
            </div>

            <!-- Info Tab -->
            <div id="infoTab" class="tab-content active" data-testid="info-tab">
                <div class="info-card">
                    <div class="info-row">
                        <div class="info-label">Owner:</div>
                        <div class="info-value" id="profileOwner"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">NFT ID:</div>
                        <div class="info-value" id="profileNftId"></div>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="info-card">
                    <div class="info-row">
                        <div class="info-label">Namespace ID:</div>
                        <div class="info-value" id="profileNamespace"></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Registration Date:</div>
                        <div class="info-value" id="profileDate"></div>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="info-card">
                    <div class="info-row">
                        <div class="info-label">Staked AI:</div>
                        <div class="info-value">
                            <span class="staked-amount">
                                <span class="kai-icon"></span>
                                <span id="profileStaked"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rewards Tab -->
            <div id="rewardsTab" class="tab-content" data-testid="rewards-tab">
                <div class="info-card">
                    <h3 style="margin-bottom: 16px;">Staking Rewards</h3>
                    <div class="info-row">
                        <div class="info-label">Accrued Rewards:</div>
                        <div class="info-value">
                            <span class="staked-amount">
                                <span class="kai-icon"></span>
                                <span>0</span>
                            </span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">APR:</div>
                        <div class="info-value">8.00%</div>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="info-card">
                    <h3 style="margin-bottom: 16px;">Rewards Claim History</h3>
                    <div class="empty-state">
                        <p>No rewards claimed yet</p>
                    </div>
                </div>
            </div>

            <!-- Delegations Tab -->
            <div id="delegationsTab" class="tab-content" data-testid="delegations-tab">
                <div class="info-card">
                    <div class="info-row">
                        <div class="info-label">AI delegated to this identity:</div>
                        <div class="info-value">
                            <span class="staked-amount">
                                <span class="kai-icon"></span>
                                <span>0</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="info-card">
                    <div class="empty-state">
                        <p>Identity has not set any delegations</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="page" data-testid="register-page">
            <div class="register-card">
                <h1>Register Identity</h1>
                <p class="subtitle">Claim your decentralized identity on Hanzo, Lux, or Zoo networks</p>

                <div id="registerStatus" class="status"></div>

                <div id="registerWalletInfo" class="wallet-info">
                    <div>Connected: <span id="registerWalletAddress" class="wallet-address"></span></div>
                    <div class="balance">Balance: <span id="registerBalance"></span> AI</div>
                </div>

                <div class="form-group">
                    <label for="identityName">Identity Name</label>
                    <input
                        type="text"
                        id="identityName"
                        placeholder="yourname"
                        pattern="[a-z0-9]+"
                        data-testid="identity-name-input"
                    >
                    <div id="priceDisplay" class="price-display">Enter a name to see pricing</div>
                </div>

                <div class="form-group">
                    <label for="namespace">Network</label>
                    <select id="namespace" data-testid="namespace-select">
                        <option value="31337">Localhost (Testing)</option>
                        <option value="36963">Hanzo Mainnet</option>
                        <option value="96369">Lux Mainnet</option>
                        <option value="200200">Zoo Mainnet</option>
                    </select>
                </div>

                <button id="registerConnectBtn" onclick="connectWallet()" class="btn" data-testid="register-connect-button">
                    Connect Wallet
                </button>

                <button id="registerSubmitBtn" onclick="registerIdentity()" style="display: none;" class="btn" data-testid="register-submit-button">
                    Register Identity
                </button>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, registry, aiToken, nft;
        let connectedAddress;
        let allIdentities = [];
        let displayedIdentities = [];
        const IDENTITIES_PER_PAGE = 10;

        const CONTRACT_ADDRESSES = {
            registry: '0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9',
            aiToken: '0x5FbDB2315678afecb367f032d93F642f64180aa3',
            nft: '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512'
        };

        const REGISTRY_ABI = [
            "function claimIdentity((string name, uint256 namespace, uint256 stakeAmount, address owner, string referrer)) external",
            "function identityStakeRequirement(string name, uint256 namespace, bool hasReferrer) external view returns (uint256)",
            "function identities(string) external view returns (address owner, uint256 namespace, uint256 nftId, uint256 stakeAmount)",
            "event IdentityClaimed(string indexed name, uint256 indexed namespace, address indexed owner, uint256 nftId)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address owner) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)"
        ];

        const NFT_ABI = [
            "function ownerOf(uint256 tokenId) external view returns (address)"
        ];

        // Routing
        function navigate(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('[data-route]').forEach(link => link.classList.remove('active'));

            const pageElement = document.getElementById(page + 'Page');
            if (pageElement) {
                pageElement.classList.add('active');
                document.querySelectorAll(`[data-route="${page}"]`).forEach(link => link.classList.add('active'));

                if (page === 'identities') {
                    loadIdentities();
                }
            }
        }

        function handleRoute() {
            const hash = window.location.hash.slice(1) || '/';

            if (hash === '/' || hash === '') {
                navigate('home');
            } else if (hash === '/identities') {
                navigate('identities');
            } else if (hash === '/register') {
                navigate('register');
            } else if (hash.startsWith('/identity/')) {
                const identityName = hash.replace('/identity/', '');
                navigate('profile');
                loadProfile(identityName);
            } else {
                navigate('home');
            }
        }

        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        // Status messages
        function showStatus(message, type, elementId = 'registerStatus') {
            const statusEl = document.getElementById(elementId);
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                statusEl.style.display = 'block';
            }
        }

        // Wallet Connection
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('Please install MetaMask or use a Web3 browser', 'error');
                    return;
                }

                showStatus('Connecting wallet...', 'info');

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                connectedAddress = await signer.getAddress();

                registry = new ethers.Contract(CONTRACT_ADDRESSES.registry, REGISTRY_ABI, signer);
                aiToken = new ethers.Contract(CONTRACT_ADDRESSES.aiToken, TOKEN_ABI, signer);
                nft = new ethers.Contract(CONTRACT_ADDRESSES.nft, NFT_ABI, signer);

                const balance = await aiToken.balanceOf(connectedAddress);

                // Update all wallet info displays
                const walletAddress = connectedAddress.slice(0, 6) + '...' + connectedAddress.slice(-4);
                document.getElementById('registerWalletAddress').textContent = walletAddress;
                document.getElementById('registerBalance').textContent = ethers.utils.formatEther(balance);
                document.getElementById('registerWalletInfo').classList.add('show');

                // Update buttons
                document.getElementById('navConnectBtn').textContent = walletAddress;
                document.getElementById('navConnectBtn').disabled = true;
                document.getElementById('registerConnectBtn').style.display = 'none';
                document.getElementById('registerSubmitBtn').style.display = 'block';

                showStatus('Wallet connected successfully!', 'success');

            } catch (error) {
                console.error(error);
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Load Identities
        async function loadIdentities() {
            if (!provider) {
                provider = new ethers.providers.JsonRpcProvider('http://localhost:8545');
                registry = new ethers.Contract(CONTRACT_ADDRESSES.registry, REGISTRY_ABI, provider);
            }

            try {
                // Get all IdentityClaimed events
                const filter = registry.filters.IdentityClaimed();
                const events = await registry.queryFilter(filter);

                allIdentities = [];
                for (const event of events) {
                    const name = event.args.name;
                    try {
                        const identity = await registry.identities(name);
                        if (identity.owner !== ethers.constants.AddressZero) {
                            allIdentities.push({
                                name: name,
                                owner: identity.owner,
                                namespace: identity.namespace.toString(),
                                nftId: identity.nftId.toString(),
                                stakeAmount: ethers.utils.formatEther(identity.stakeAmount)
                            });
                        }
                    } catch (e) {
                        console.log(`Skipping ${name}:`, e.message);
                    }
                }

                // Sort by stake amount descending
                allIdentities.sort((a, b) => parseFloat(b.stakeAmount) - parseFloat(a.stakeAmount));

                displayedIdentities = allIdentities.slice(0, IDENTITIES_PER_PAGE);
                renderIdentities();

            } catch (error) {
                console.error('Error loading identities:', error);
                document.getElementById('identitiesList').innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load identities. Make sure you're connected to the correct network.</p>
                    </div>
                `;
            }
        }

        function renderIdentities() {
            const listEl = document.getElementById('identitiesList');

            if (displayedIdentities.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <p>No identities found</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = displayedIdentities.map(identity => `
                <div class="table-row" onclick="window.location.hash = '/identity/${identity.name}'" data-testid="identity-row">
                    <div class="identity-name">@@${identity.name}</div>
                    <div class="staked-amount">
                        <span class="kai-icon"></span>
                        <span>${identity.stakeAmount}</span>
                    </div>
                </div>
            `).join('');

            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayedIdentities.length >= allIdentities.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
            }
        }

        function loadMoreIdentities() {
            const currentLength = displayedIdentities.length;
            displayedIdentities = allIdentities.slice(0, currentLength + IDENTITIES_PER_PAGE);
            renderIdentities();
        }

        // Search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    if (query === '') {
                        displayedIdentities = allIdentities.slice(0, IDENTITIES_PER_PAGE);
                    } else {
                        displayedIdentities = allIdentities.filter(id =>
                            id.name.toLowerCase().includes(query)
                        );
                    }
                    renderIdentities();
                });
            }
        });

        // Load Profile
        async function loadProfile(name) {
            if (!provider) {
                provider = new ethers.providers.JsonRpcProvider('http://localhost:8545');
                registry = new ethers.Contract(CONTRACT_ADDRESSES.registry, REGISTRY_ABI, provider);
            }

            document.getElementById('profileName').textContent = `@@${name}`;

            try {
                const identity = await registry.identities(name);

                if (identity.owner === ethers.constants.AddressZero) {
                    document.getElementById('profileOwner').textContent = 'Identity not found';
                    return;
                }

                document.getElementById('profileOwner').textContent = identity.owner;
                document.getElementById('profileNftId').textContent = identity.nftId.toString();
                document.getElementById('profileNamespace').textContent = identity.namespace.toString();
                document.getElementById('profileStaked').textContent = ethers.utils.formatEther(identity.stakeAmount);
                document.getElementById('profileDate').textContent = new Date().toLocaleDateString();

            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profileOwner').textContent = 'Error loading profile';
            }
        }

        // Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Price calculation
        async function updatePrice() {
            const name = document.getElementById('identityName').value.toLowerCase();
            const namespace = document.getElementById('namespace').value;
            const priceDisplay = document.getElementById('priceDisplay');

            if (!name || !registry) {
                priceDisplay.textContent = 'Enter a name to see pricing';
                return;
            }

            try {
                const stake = await registry.identityStakeRequirement(name, namespace, false);
                const stakeAI = ethers.utils.formatEther(stake);
                const actualStake = parseFloat(stakeAI) * 1.001;
                priceDisplay.textContent = `Required stake: ${stakeAI} AI (+ 0.1% burn ‚âà ${actualStake.toFixed(2)} AI total)`;
            } catch (error) {
                priceDisplay.textContent = 'Error calculating price';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('identityName');
            const namespaceSelect = document.getElementById('namespace');
            if (nameInput) nameInput.addEventListener('input', updatePrice);
            if (namespaceSelect) namespaceSelect.addEventListener('change', updatePrice);
        });

        // Register Identity
        async function registerIdentity() {
            try {
                const name = document.getElementById('identityName').value.toLowerCase();
                const namespace = parseInt(document.getElementById('namespace').value);

                if (!name.match(/^[a-z0-9]+$/)) {
                    showStatus('Identity name must contain only lowercase letters and numbers', 'error');
                    return;
                }

                showStatus('Calculating required stake...', 'info');
                const stakeAmount = await registry.identityStakeRequirement(name, namespace, false);

                showStatus('Checking allowance...', 'info');
                const allowance = await aiToken.allowance(connectedAddress, CONTRACT_ADDRESSES.registry);

                if (allowance.lt(stakeAmount)) {
                    showStatus('Approving AI tokens...', 'info');
                    const approveTx = await aiToken.approve(CONTRACT_ADDRESSES.registry, ethers.constants.MaxUint256);
                    await approveTx.wait();
                }

                showStatus('Registering identity... Please confirm transaction', 'info');

                const params = {
                    name: name,
                    namespace: namespace,
                    stakeAmount: stakeAmount,
                    owner: connectedAddress,
                    referrer: ''
                };

                const tx = await registry.claimIdentity(params);
                showStatus('Transaction submitted. Waiting for confirmation...', 'info');

                const receipt = await tx.wait();

                const newBalance = await aiToken.balanceOf(connectedAddress);
                document.getElementById('registerBalance').textContent = ethers.utils.formatEther(newBalance);

                showStatus(`üéâ Identity @@${name} registered successfully! TX: ${receipt.transactionHash.slice(0, 10)}...`, 'success');

                setTimeout(() => {
                    window.location.hash = `/identity/${name}`;
                }, 2000);

            } catch (error) {
                console.error(error);
                let errorMsg = 'Registration failed: ';
                if (error.message.includes('user rejected')) {
                    errorMsg += 'Transaction rejected by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg += 'Insufficient AI tokens';
                } else if (error.message.includes('already claimed')) {
                    errorMsg += 'Identity name already taken';
                } else {
                    errorMsg += error.message;
                }
                showStatus(errorMsg, 'error');
            }
        }
    </script>
</body>
</html>
